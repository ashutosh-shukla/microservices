package com.bank.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;
import com.bank.model.KYCDocument;
import com.bank.services.KYCDocumentService;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

@Controller
@RequestMapping("/kyc/api")
@CrossOrigin(origins = "http://localhost:7071")
public class KYCController {
    
    @Autowired
    private KYCDocumentService kycDocumentService;
    
    @GetMapping("/health")
    @ResponseBody
    public String healthCheck() {
        return "KYC Service is UP";
    }
    
    // API endpoint for file upload (called by frontend)
    @PostMapping("/upload")
    @ResponseBody
    public ResponseEntity<Map<String, Object>> uploadKYCDocuments(
            @RequestParam("fullName") String fullName,
            @RequestParam("email") String email,
            @RequestParam("phoneNumber") String phoneNumber,
            @RequestParam(value = "aadharFront", required = false) MultipartFile aadharFront,
            @RequestParam(value = "aadharBack", required = false) MultipartFile aadharBack,
            @RequestParam(value = "panFront", required = false) MultipartFile panFront,
            @RequestParam(value = "panBack", required = false) MultipartFile panBack,
            @RequestParam(value = "photograph", required = false) MultipartFile photograph) {
        
        Map<String, Object> response = new HashMap<>();
        
        try {
            // Validate required fields
            if (fullName == null || fullName.trim().isEmpty() ||
                email == null || email.trim().isEmpty() ||
                phoneNumber == null || phoneNumber.trim().isEmpty()) {
                response.put("error", "All personal details are required");
                return ResponseEntity.badRequest().body(response);
            }
            
            // Validate email format
            if (!email.matches("^[A-Za-z0-9+_.-]+@(.+)$")) {
                response.put("error", "Please enter a valid email address");
                return ResponseEntity.badRequest().body(response);
            }
            
            // Validate phone number format
            if (!phoneNumber.matches("^[0-9]{10}$")) {
                response.put("error", "Please enter a valid 10-digit phone number");
                return ResponseEntity.badRequest().body(response);
            }
            
            KYCDocument savedDocument = kycDocumentService.saveKYCDocument(
                fullName.trim(), email.trim(), phoneNumber.trim(),
                aadharFront, aadharBack, panFront, panBack, photograph
            );
            
            response.put("success", true);
            response.put("message", "KYC documents uploaded successfully!");
            response.put("id", savedDocument.getId());
            
            return ResponseEntity.ok(response);
            
        } catch (IOException e) {
            response.put("error", "File validation error: " + e.getMessage());
            return ResponseEntity.badRequest().body(response);
        } catch (RuntimeException e) {
            response.put("error", e.getMessage());
            return ResponseEntity.badRequest().body(response);
        } catch (Exception e) {
            response.put("error", "An unexpected error occurred. Please try again.");
            return ResponseEntity.internalServerError().body(response);
        }
    }
    
    // Direct upload endpoint (for direct backend access)
    @PostMapping("/direct-upload")
    public String directUploadKYCDocuments(
            @RequestParam("fullName") String fullName,
            @RequestParam("email") String email,
            @RequestParam("phoneNumber") String phoneNumber,
            @RequestParam("aadharFront") MultipartFile aadharFront,
            @RequestParam("aadharBack") MultipartFile aadharBack,
            @RequestParam("panFront") MultipartFile panFront,
            @RequestParam("panBack") MultipartFile panBack,
            @RequestParam("photograph") MultipartFile photograph,
            RedirectAttributes redirectAttributes) {
        
        try {
            // Validate required fields
            if (fullName == null || fullName.trim().isEmpty() ||
                email == null || email.trim().isEmpty() ||
                phoneNumber == null || phoneNumber.trim().isEmpty()) {
                redirectAttributes.addFlashAttribute("error", "All personal details are required");
                return "redirect:/kyc/api/upload-form";
            }
            
            // Validate email format
            if (!email.matches("^[A-Za-z0-9+_.-]+@(.+)$")) {
                redirectAttributes.addFlashAttribute("error", "Please enter a valid email address");
                return "redirect:/kyc/api/upload-form";
            }
            
            // Validate phone number format
            if (!phoneNumber.matches("^[0-9]{10}$")) {
                redirectAttributes.addFlashAttribute("error", "Please enter a valid 10-digit phone number");
                return "redirect:/kyc/api/upload-form";
            }
            
            KYCDocument savedDocument = kycDocumentService.saveKYCDocument(
                fullName.trim(), email.trim(), phoneNumber.trim(),
                aadharFront, aadharBack, panFront, panBack, photograph
            );
            
            redirectAttributes.addFlashAttribute("success",
                "KYC documents uploaded successfully! Reference ID: " + savedDocument.getId());
                
        } catch (IOException e) {
            redirectAttributes.addFlashAttribute("error", "File validation error: " + e.getMessage());
        } catch (RuntimeException e) {
            redirectAttributes.addFlashAttribute("error", e.getMessage());
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "An unexpected error occurred. Please try again.");
        }
        
        return "redirect:/kyc/api/upload-form";
    }
    
    @GetMapping("/upload-form")
    public String showUploadForm(Model model) {
        return "kyc-upload";
    }
    
    // API endpoint for admin panel (called by frontend)
    @GetMapping("/admin")
    @ResponseBody
    public ResponseEntity<List<KYCDocument>> getAllDocuments() {
        try {
            List<KYCDocument> documents = kycDocumentService.getAllDocuments();
            return ResponseEntity.ok(documents);
        } catch (Exception e) {
            return ResponseEntity.internalServerError().build();
        }
    }
    
    // Direct admin panel endpoint
    @GetMapping("/admin-panel")
    public String showAdminPanel(Model model) {
        List<KYCDocument> documents = kycDocumentService.getAllDocuments();
        model.addAttribute("documents", documents);
        return "admin-panel-simple";
    }
    
    // API endpoint for viewing document (called by frontend)
    @GetMapping("/admin/view/{id}")
    @ResponseBody
    public ResponseEntity<KYCDocument> getDocumentById(@PathVariable Long id) {
        try {
            Optional<KYCDocument> documentOpt = kycDocumentService.getDocumentById(id);
            if (documentOpt.isPresent()) {
                return ResponseEntity.ok(documentOpt.get());
            } else {
                return ResponseEntity.notFound().build();
            }
        } catch (Exception e) {
            return ResponseEntity.internalServerError().build();
        }
    }
    
    // Direct view document endpoint
    @GetMapping("/view/{id}")
    public String viewDocument(@PathVariable Long id, Model model) {
        Optional<KYCDocument> documentOpt = kycDocumentService.getDocumentById(id);
        if (documentOpt.isPresent()) {
            model.addAttribute("document", documentOpt.get());
            return "document-view";
        } else {
            return "redirect:/kyc/api/admin-panel?error=Document not found";
        }
    }
    
    // API endpoint for updating status (called by frontend)
    @PostMapping("/admin/update-status/{id}")
    @ResponseBody
    public ResponseEntity<Map<String, String>> updateDocumentStatus(
            @PathVariable Long id,
            @RequestBody Map<String, String> request) {
        
        Map<String, String> response = new HashMap<>();
        try {
            String status = request.get("status");
            kycDocumentService.updateDocumentStatus(id, status);
            response.put("message", "Status updated successfully");
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            response.put("error", "Error updating status: " + e.getMessage());
            return ResponseEntity.badRequest().body(response);
        }
    }
    
    // Direct update status endpoint
    @PostMapping("/update-status/{id}")
    public String updateStatus(@PathVariable Long id,
                              @RequestParam String status,
                              RedirectAttributes redirectAttributes) {
        try {
            kycDocumentService.updateDocumentStatus(id, status);
            redirectAttributes.addFlashAttribute("success", "Status updated successfully");
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "Error updating status");
        }
        return "redirect:/kyc/api/admin-panel";
    }
    
    // API endpoint for deleting document (called by frontend)
    @PostMapping("/admin/delete/{id}")
    @ResponseBody
    public ResponseEntity<Map<String, String>> deleteDocumentApi(@PathVariable Long id) {
        Map<String, String> response = new HashMap<>();
        try {
            kycDocumentService.deleteDocument(id);
            response.put("message", "Document deleted successfully");
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            response.put("error", "Error deleting document: " + e.getMessage());
            return ResponseEntity.badRequest().body(response);
        }
    }
    
    // Direct delete endpoint
    @PostMapping("/delete/{id}")
    public String deleteDocument(@PathVariable Long id, RedirectAttributes redirectAttributes) {
        try {
            kycDocumentService.deleteDocument(id);
            redirectAttributes.addFlashAttribute("success", "Document deleted successfully");
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "Error deleting document");
        }
        return "redirect:/kyc/api/admin-panel";
    }
}
